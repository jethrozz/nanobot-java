# Nanobot-Java 产品设计文档

## 1. 产品概述

### 1.1 产品定位
**Nanobot-Java** 是 Nanobot 项目的 Java 语言实现版本，是一个超轻量级的个人 AI 助手框架。基于 Spring Boot + Spring AI 构建，旨在为 Java 开发者提供一个可研究、易修改、极度便携的 AI 助手解决方案。

### 1.2 核心价值
- **超轻量级**：核心代码精简，相比 Python 版本更易于 Java 开发者理解和维护
- **多平台支持**：支持 9+ 聊天平台接入，统一消息处理
- **模型无关**：支持 12+ LLM 提供商，可轻松扩展
- **易于扩展**：插件化工具系统、技能系统、消息总线
- **企业级特性**：基于 Spring 生态，天然支持企业级特性（配置中心、服务发现、监控等）

### 1.3 目标用户
- Java/Java 开发者
- 需要自建 AI 助手的企业团队
- AI 应用研究者
- 自动化运维工程师

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 多平台消息接入
| 平台 | 支持方式 | 状态 |
|------|----------|------|
| 飞书/Lark | WebSocket | P0 |
| 企业微信 | Webhook/API | P0 |
| QQ | QQ Bot SDK | P0 |
| 钉钉 | Stream Mode | P1 |
| Telegram | Long Polling | P1 |
| Discord | Bot API | P2 |
| Slack | Socket Mode | P2 |
| 邮件 | IMAP/SMTP | P2 |

#### 2.1.2 AI 模型支持
| 提供商 | 用途 | 优先级 |
|--------|------|--------|
| 智谱AI (GLM) | GLM-4 系列 | P0 |
| DeepSeek | 深度求索 V3 | P0 |
| 阿里云百炼 | Qwen 系列 | P1 |
| Moonshot | Kimi | P1 |
| Google Gemini | Gemini | P2 |
| OpenRouter | 聚合网关 | P1 |
| vLLM | 本地模型 | P2 |

#### 2.1.3 Agent 工具箱
| 工具类别 | 工具列表 | 优先级 |
|----------|----------|--------|
| 文件操作 | read, write, edit, list | P0 |
| Shell 执行 | exec (带超时保护) | P0 |
| Web 交互 | search, fetch | P1 |
| 消息发送 | message (发送到频道) | P0 |
| 后台任务 | spawn (子 Agent) | P1 |
| 定时任务 | cron 管理 | P1 |

#### 2.1.4 记忆与上下文
- **会话管理**：基于 JSONL 的对话持久化
- **记忆存储**：每日笔记 + 长期记忆
- **引导文件**：AGENTS.md, SOUL.md, USER.md, TOOLS.md
- **技能加载**：渐进式加载策略

#### 2.1.5 定时任务服务
- Cron 表达式支持（重复任务）
- 间隔任务（每 N 秒）
- 一次性任务（指定时间戳）
- 任务管理（列表、增删、启停、手动执行）

#### 2.1.6 心跳服务
- 每 30 分钟运行一次
- 检查 HEARTBEAT.md 执行周期性任务
- 通过 Agent 执行任务

---

### 2.2 管理功能

#### 2.2.1 配置管理
- 统一配置文件（YAML/Properties）
- 环境变量支持
- Provider 配置自动发现
- 热更新支持（可选）

#### 2.2.2 CLI 命令
| 命令 | 功能 | 优先级 |
|------|------|--------|
| onboarding | 初始化配置和工作区 | P0 |
| agent | 单次/交互式对话 | P0 |
| gateway | 启动网关服务 | P0 |
| status | 配置状态查看 | P1 |
| channels | 频道管理 | P1 |
| cron | 定时任务管理 | P1 |

---

### 2.3 安全功能

#### 2.3.1 工作区限制
- 文件操作限制在工作区目录
- Shell 命令执行目录限制
- 路径遍历防护

#### 2.3.2 访问控制
- 频道级别白名单
- 用户级别权限控制
- API Key 管理

#### 2.3.3 Shell 安全
- 超时保护（默认 60s）
- 危险命令黑名单
- 可配置工作目录

---

## 3. 非功能需求

### 3.1 性能要求
- 启动时间 < 5 秒
- 单次请求响应 < 3 秒（不含 LLM 响应时间）
- 支持并发 50+ 会话
- 内存占用 < 512MB (空闲)

### 3.2 可靠性要求
- 进程崩溃自动重启
- 消息处理失败重试
- 配置错误友好提示
- LLM 调用降级处理

### 3.3 可维护性要求
- 模块化设计，高内聚低耦合
- 统一日志格式（结构化日志）
- 健康检查端点
- 指标暴露（Prometheus）

### 3.4 可扩展性要求
- 新增 Provider：2 步完成
- 新增 Channel：实现接口即可
- 新增 Tool：注册即用
- 新增 Skill：Markdown 文件

---

## 4. 技术选型

### 4.1 核心框架
| 组件 | 技术选型 | 版本 | 用途 |
|------|----------|------|------|
| 应用框架 | Spring Boot | 3.3+ | 应用基础 |
| AI 集成 | Spring AI | 1.0+ | LLM 统一接口 |
| Web 容器 | Tomcat/Undertow | (内嵌) | HTTP 服务 |
| 异步处理 | Project Reactor | (Spring) | 响应式编程 |
| 任务调度 | Spring Scheduling | (Spring) | 定时任务 |

### 4.2 依赖库
| 依赖 | 用途 |
|------|------|
| Lombok | 减少样板代码 |
| MapStruct | 对象映射 |
| Jackson | JSON 处理 |
| OkHttp/WebClient | HTTP 客户端 |
| Quartz | 高级任务调度（可选） |
| HikariCP | 数据库连接池（可选） |
| Logback | 日志框架 |

### 4.3 外部服务依赖
- LLM Provider API（智谱 GLM、DeepSeek、阿里云百炼等）
- 搜索 API（Brave Search，可选）
- 邮件服务器（IMAP/SMTP，可选）

---

## 5. 用户体验设计

### 5.1 首次使用流程
```bash
# 1. 安装
java -jar nanobot.jar onboarding

# 2. 配置
# 编辑 ~/.nanobot/config.yaml

# 3. 启动
java -jar nanobot.jar gateway
```

### 5.2 交互式对话
```bash
# 单次消息
java -jar nanobot.jar agent -m "今天天气怎么样？"

# 交互模式
java -jar nanobot.jar agent
> 你好，我是 nanobot！
> 今天天气怎么样？
[AI 回复...]
```

### 5.3 配置示例
```yaml
nanobot:
  agents:
    default:
      model: "glm-4-plus"
      workspace: "/Users/xxx/nanobot-workspace"
      maxIterations: 10

  providers:
    glm:
      apiKey: "xxx"
      baseUrl: "https://open.bigmodel.cn/api/paas/v4"

  channels:
    telegram:
      enabled: true
      botToken: "xxx"
      allowFrom: [123456789]

  tools:
    restrictToWorkspace: true
    webSearch:
      enabled: true
      apiKey: "xxx"
```

---

## 6. 路线图

### Phase 1: MVP (最小可行产品)
- [x] Spring Boot + Spring AI 项目搭建
- [ ] 核心引擎（AgentLoop, ContextBuilder）
- [ ] 基础工具（文件、Shell）
- [ ] GLM/DeepSeek Provider
- [ ] 飞书/企业微信/QQ Channel
- [ ] 配置系统

### Phase 2: 核心功能
- [ ] 更多 Provider（Qwen、Moonshot、Gemini 等）
- [ ] 更多 Channel（钉钉、Telegram、Discord）
- [ ] 工具扩展（Web, 消息）
- [ ] 记忆系统
- [ ] 技能系统

### Phase 3: 高级特性
- [ ] 定时任务服务
- [ ] 心跳服务
- [ ] 子 Agent 系统
- [ ] CLI 命令完善

### Phase 4: 企业特性
- [ ] 配置中心集成
- [ ] 监控告警
- [ ] 分布式支持
- [ ] 高可用部署

---

## 7. 成功指标

### 7.1 技术指标
- 代码行数 < 10,000 行（核心）
- 启动时间 < 5 秒
- 单元测试覆盖率 > 70%
- 零安全漏洞

### 7.2 用户指标
- 配置时间 < 10 分钟
- 新增 Provider 时间 < 5 分钟
- 新增 Channel 时间 < 30 分钟
- 文档完整度 > 90%

---

## 8. 风险与限制

### 8.1 技术风险
| 风险 | 影响 | 应对 |
|------|------|------|
| Spring AI 成熟度 | API 变更 | 版本锁定，抽象层隔离 |
| 异步处理复杂度 | 开发效率 | 优先同步实现，后优化 |
| 内存占用 | 资源限制 | 配置调优，懒加载 |

### 8.2 功能限制
- WhatsApp 通道需要 Node.js 桥接（复用 Python 版本）
- 某些平台 SDK 可能缺少 Java 版本
- 本地模型支持依赖 vLLM/Ollama

---

## 9. 附录

### 9.1 参考文档
- [Nanobot Python 版本](https://github.com/nanobot-framework/nanobot)
- [Spring AI 官方文档](https://docs.spring.io/spring-ai/reference/)
- [LiteLLM 文档](https://docs.litellm.ai/)

### 9.2 术语表
| 术语 | 定义 |
|------|------|
| Agent | AI 助手实例，负责处理用户消息 |
| Channel | 聊天平台接入渠道 |
| Provider | LLM 服务提供商 |
| Tool | Agent 可调用的工具 |
| Skill | Agent 的技能包（Markdown 格式） |
| Subagent | 后台执行的子 Agent |
| MessageBus | 消息路由总线 |
